<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  serverTimestamp,
  query,
  orderBy,
  onSnapshot,
  getDocs,
  doc,
  deleteDoc
} from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyATfxCXQlXlzDZYVJXbgaLbzSp3v9oltdk",
  authDomain: "yomath-e3bf6.firebaseapp.com",
  projectId: "yomath-e3bf6",
  storageBucket: "omath-e3bf6.firebasestorage.app",
  messagingSenderId: "828481107544",
  appId: "1:828481107544:web:f5d42aaa18f7ae15293c2d",
  measurementId: "G-DS7EDV6X1P"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const chatBox = document.getElementById('chatBox');
const messageInput = document.getElementById('messageInput');
const chatContainer = document.getElementById('chatContainer');

let username = localStorage.getItem("chatUsername") || "";
const adminUsername = "WalterWhite";

// Prompt modal setup
const usernameModal = document.createElement("div");
usernameModal.id = "usernameModal";
usernameModal.innerHTML = `
  <div class="modalContent">
    <h2>Indtast dit brugernavn</h2>
    <input type="text" id="usernameInput" placeholder="Skriv navn her..." />
    <div><button id="confirmUsername">OK</button></div>
    <div id="usernameError"></div>
  </div>
`;
document.body.appendChild(usernameModal);

function showModal() {
  usernameModal.style.display = "flex";
}

function hideModal() {
  usernameModal.style.display = "none";
}

if (!username) {
  showModal();
}

document.getElementById("confirmUsername").onclick = () => {
  const input = document.getElementById("usernameInput").value.trim();
  if (input) {
    username = input;
    localStorage.setItem("chatUsername", username);
    hideModal();
    setupChat();
  } else {
    document.getElementById("usernameError").textContent = "Indtast et gyldigt brugernavn.";
  }
};

if (username) {
  setupChat();
}

function setupChat() {
  const deleteBtn = document.getElementById("deleteBtn");
  if (username === adminUsername) {
    deleteBtn.style.display = "inline-block";
    deleteBtn.onclick = async () => {
      const confirmDelete = confirm("Er du sikker pÃ¥, du vil slette alle beskeder?");
      if (!confirmDelete) return;
      const messagesSnapshot = await getDocs(collection(db, "messages"));
      for (const messageDoc of messagesSnapshot.docs) {
        await deleteDoc(doc(db, "messages", messageDoc.id));
      }
    };
  }

  messageInput.addEventListener("keydown", async (e) => {
    if (e.key === "Enter") {
      const text = messageInput.value.trim();
      if (text) {
        await addDoc(collection(db, "messages"), {
          user: username,
          message: text,
          timestamp: serverTimestamp()
        });
        messageInput.value = "";
      }
    }
  });

  const q = query(collection(db, "messages"), orderBy("timestamp"));
  onSnapshot(q, (snapshot) => {
    chatBox.innerHTML = "";
    snapshot.forEach(doc => {
      const msg = doc.data();
      chatBox.innerHTML += `<div><strong>${msg.user}:</strong> ${msg.message}</div>`;
    });
    chatBox.scrollTop = chatBox.scrollHeight;
  });
}
</script>
